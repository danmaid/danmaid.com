<!DOCTYPE html>
<html>
  <head>
    <title>Account Book</title>
    <meta http-equiv="content-language" content="ja" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        background-color: #000;
        color: #eee;
      }
      .partial {
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th>日時</th>
          <th>相手</th>
          <th>品名</th>
          <th>価格</th>
          <th>支払方法</th>
          <th>レシート/領収書</th>
          <td><button onclick="refresh()">refresh</button><button onclick="sample()">sample</button></td>
          <script>
            async function refresh() {
              const res = await fetch('/payments', { headers: { Accept: 'application/json' } })
              const data = await res.json()
              render(data)
            }
            async function sample() {
              const data = [
                { date: new Date('2022-12-01').toISOString(), partner: 'コンビニ' },
                { date: new Date('2022-12-03').toISOString(), partner: '駐車場' },
              ]
              render(data)
            }
          </script>
        </tr>
        <tr>
          <td><input id="date" /></td>
          <td><input id="partner" /></td>
          <td><input id="item" /></td>
          <td><input id="price" /></td>
          <td>
            <input id="method" />
            <!-- <select>
              <option selected>現金</option>
              <optgroup label="振り込み">
                <option>埼玉りそな銀行</option>
              </optgroup>
              <optgroup label="クレジットカード">
                <option>りそなデビット xxxx6675</option>
              </optgroup>
              <optgroup label="立て替え">
                <option>山田 寛治</option>
                <option>その他</option>
              </optgroup>
            </select> -->
          </td>
          <td><input id="receipt" /></td>
          <td><button onclick="add()">add</button></td>
          <script>
            async function add() {
              const date = document.getElementById('date').value
              const partner = document.getElementById('partner').value
              const item = document.getElementById('item').value
              const price = document.getElementById('price').value
              const method = document.getElementById('method').value
              const receipt = document.getElementById('receipt').value
              const payment = { date, partner, item, price, method, receipt }
              const row = renderItem(payment)
              row.classList.add('partial')
              const res = await fetch('/payments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payment),
              })
              if (res.ok) {
                row.id = await res.json()
                row.classList.remove('partial')
              }
            }
          </script>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <template id="row">
      <tr id="tr">
        <td id="date"></td>
        <td id="partner"></td>
        <td id="item"></td>
        <td id="price"></td>
        <td id="method"></td>
        <td id="receipt"></td>
        <td><button id="edit">edit</button><button id="copy">copy</button><button id="delete">delete</button></td>
      </tr>
    </template>
    <template id="row-edit">
      <tr id="tr">
        <td><input id="date" /></td>
        <td><input id="partner" /></td>
        <td><input id="item" /></td>
        <td><input id="price" /></td>
        <td><input id="method" /></td>
        <td><input id="receipt" /></td>
        <td><button id="commit">commit</button><button id="cancel">cancel</button></td>
      </tr>
    </template>
    <script>
      const tbody = document.getElementById('tbody')
      function render(items) {
        tbody.innerHTML = ''
        items.forEach(renderItem)
      }
      function renderItem({ date, partner, item, price, method, receipt, id }) {
        const template = document.getElementById('row')
        const fragment = template.content.cloneNode(true)
        const tr = fragment.querySelector('#tr')
        if (id) tr.id = id
        fragment.querySelector('#date').textContent = date
        fragment.querySelector('#partner').textContent = partner
        fragment.querySelector('#item').textContent = item
        fragment.querySelector('#price').textContent = price
        fragment.querySelector('#method').textContent = method
        fragment.querySelector('#receipt').textContent = receipt
        if (id) {
          fragment.querySelector('#edit').onclick = () => {
            const template = document.getElementById('row-edit')
            const editor = template.content.cloneNode(true)
            const row = editor.querySelector('#tr')
            editor.querySelector('#date').value = date || ''
            editor.querySelector('#partner').value = partner || ''
            editor.querySelector('#item').value = item || ''
            editor.querySelector('#price').value = price || ''
            editor.querySelector('#method').value = method || ''
            editor.querySelector('#receipt').value = receipt || ''
            editor.querySelector('#commit').onclick = async () => {
              const date = row.querySelector('#date').value
              const partner = row.querySelector('#partner').value
              const item = row.querySelector('#item').value
              const price = row.querySelector('#price').value
              const method = row.querySelector('#method').value
              const receipt = row.querySelector('#receipt').value
              row.replaceWith(tr)
              tr.classList.add('partial')
              const res = await fetch(`/payments/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, partner, item, price, method, receipt }),
              })
              if (res.ok) {
                tr.querySelector('#date').textContent = date
                tr.querySelector('#partner').textContent = partner
                tr.querySelector('#item').textContent = item
                tr.querySelector('#price').textContent = price
                tr.querySelector('#method').textContent = method
                tr.querySelector('#receipt').textContent = receipt
                tr.classList.remove('partial')
              }
            }
            editor.querySelector('#cancel').onclick = () => row.replaceWith(tr)
            tr.replaceWith(row)
          }
          fragment.querySelector('#delete').onclick = async () => {
            tr.classList.add('partial')
            const res = await fetch(`/payments/${id}`, { method: 'DELETE' })
            if (res.ok) {
              tr.classList.remove('partial')
              tbody.removeChild(tr)
            }
          }
        }
        fragment.querySelector('#copy').onclick = () => {
          document.getElementById('date').value = date || ''
          document.getElementById('partner').value = partner || ''
          document.getElementById('item').value = item || ''
          document.getElementById('price').value = price || ''
          document.getElementById('method').value = method || ''
          document.getElementById('receipt').value = receipt || ''
        }
        tbody.append(fragment)
        return tr
      }
    </script>

    <dm-matrix-code
      src="/"
      style="position: fixed; top: 0; left: 0; bottom: 0; right: 0; z-index: -999"
    ></dm-matrix-code>
    <script src="matrix-code.js"></script>
  </body>
</html>
