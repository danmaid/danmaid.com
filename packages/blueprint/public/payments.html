<!DOCTYPE html>
<html>
  <head>
    <title>Account Book</title>
    <meta http-equiv="content-language" content="ja" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        background-color: #000;
        color: #eee;
      }
      .partial {
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <section class="half">
      <h2>未処理</h2>
      <button id="refreshBacklogs">refresh</button>
      <div id="backlogs"></div>
      <style>
        .half {
          max-height: 50vh;
          overflow: auto;
        }
        #backlogs img {
          max-height: 200px;
          max-width: 200px;
        }
      </style>

      <script>
        const backlogs = document.getElementById('backlogs')
        document.getElementById('refreshBacklogs').onclick = async () => {
          backlogs.innerHTML = ''
          const res = await fetch('/receipts?payments=', { headers: { Accept: 'application/json' } })
          if (!res.ok) throw res
          const items = (await res.json()).map(({ path, id }) => {
            const img = document.createElement('img')
            img.src = `${path}/${id}`
            return img
          })
          backlogs.append(...items)
        }
      </script>
    </section>

    <main>
      <table>
        <thead>
          <tr>
            <th>日時</th>
            <th>相手</th>
            <th>品名</th>
            <th>価格</th>
            <th>支払方法</th>
            <th>レシート/領収書</th>
            <td><button id="refresh">refresh</button><button id="sample">sample</button></td>
          </tr>
          <tr id="add-row" is="dm-payment-table-row" edit no-action>
            <td id="actions"><button id="add">add</button><button id="clear">clear</button></td>
          </tr>
          <!-- <select>
              <option selected>現金</option>
              <optgroup label="振り込み">
                <option>埼玉りそな銀行</option>
              </optgroup>
              <optgroup label="クレジットカード">
                <option>りそなデビット xxxx6675</option>
              </optgroup>
              <optgroup label="立て替え">
                <option>山田 寛治</option>
                <option>その他</option>
              </optgroup>
            </select> -->
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <script type="module">
        import { API } from './API.js'
        import { PaymentTableRow } from './PaymentTableRow.js'

        const api = new API('/payments')
        customElements.define('dm-payment-table-row', PaymentTableRow, { extends: 'tr' })
        customElements.whenDefined('dm-payment-table-row').then(() => {
          const actions = document.getElementById('actions')
          actions.parentElement.append(actions)
        })

        document.getElementById('refresh').onclick = async () => {
          clearItems()
          const data = await api.list()
          data.forEach((v) => addItem(v))
        }
        document.getElementById('sample').onclick = async () => {
          clearItems()
          const data = [
            { date: new Date('2022-12-01').toISOString(), partner: 'コンビニ' },
            { date: new Date('2022-12-03').toISOString(), partner: '駐車場' },
          ]
          data.forEach((v) => addItem(v))
        }

        const addRow = document.getElementById('add-row')
        document.getElementById('add').onclick = async () => {
          const value = addRow.value
          const row = addItem(value)
          row.toggleAttribute('partial', true)
          const id = await api.create(value)
          row.id = id
          if (value.receipt) {
            const res = await fetch(`/receipts/${value.receipt}`, { headers: { Accept: 'application/json' } })
            if (!res.ok) throw res
            const data = await res.json()
            if (!data.payments) data.payments = id
            else if (Array.isArray(data.payments)) {
              if (!data.payments.includes(id)) data.payments.push(id)
              else throw Error('not supported.')
            } else throw Error('not supported.')
            const result = await fetch(`/receipts/${value.receipt}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              body: JSON.stringify({ payments: data.payments }),
            })
            if (!result.ok) throw result
          }
          row.removeAttribute('partial')
        }
        document.getElementById('clear').onclick = () => (addRow.value = null)

        const tbody = document.getElementById('tbody')
        const clearItems = () => (tbody.innerHTML = '')

        function addItem({ id, ...v }) {
          const row = document.createElement('tr', { is: 'dm-payment-table-row' })
          row.value = v
          row.id = id
          row.addEventListener('copy', () => (addRow.value = row.value))
          row.addEventListener('commit', async () => {
            await api.update(id, row.value)
            row.removeAttribute('partial')
          })
          row.addEventListener('delete', async () => {
            await api.delete(id)
            row.remove()
          })
          tbody.append(row)
          return row
        }
      </script>
    </main>

    <dm-matrix-code
      src="/"
      style="position: fixed; top: 0; left: 0; bottom: 0; right: 0; z-index: -999"
    ></dm-matrix-code>
    <script src="matrix-code.js"></script>
  </body>
</html>
