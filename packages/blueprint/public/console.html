<!DOCTYPE html>
<html>
  <head>
    <title>Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="console.js"></script>
    <style>
      :root {
        background-color: #000;
        color: #eee;
      }
    </style>
  </head>
  <body style="height: 100vh; margin: 0; padding: 8px; box-sizing: border-box">
    <dm-console id="console" src="/" style="height: 100%">
      <div slot="input" style="display: flex">
        <span style="flex: 1 1"></span>
        <button onclick="startCamera()">start camera</button>
        <button onclick="stopCamera()">stop camera</button>
        <dm-upload-receipt-button></dm-upload-receipt-button>
      </div>
    </dm-console>

    <div style="position: absolute; top: 0; right: 0">
      stub
      <button onclick="start()">start</button>
      <button onclick="stop()">stop</button>
      <button onclick="console.clear()">clear</button>
    </div>

    <script>
      const cons = document.getElementById('console')
      const old = cons.onmessage
      cons.onmessage = (ev) => {
        const { data } = ev
        const { date, event: receipt } = JSON.parse(data)
        if (typeof receipt.receipt === 'string') {
          const { receipt: id } = receipt
          const div = document.createElement('div')
          div.slot = 'output'
          div.textContent = `${new Date(date).toLocaleString()} レシート/領収書`
          div.style.color = '#aff'
          div.style.maxHeight = '200px'
          const img = document.createElement('img')
          img.src = `/receipts/${id}`
          img.style.maxHeight = 'inherit'
          div.append(img)
          return div
        } else return old(ev)
      }

      function startCamera() {
        fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'start',
            camera: 'labo1',
            url: 'rtmp://a.rtmp.youtube.com/live2/8bgh-fhbb-dt08-cf9b-3hyd',
          }),
        })
      }
      function stopCamera() {
        fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'stop', camera: 'labo1' }),
        })
      }
    </script>

    <script>
      class EventSourceStub extends EventTarget {
        constructor() {
          super()
          this.addEventListener('message', (...args) => this.onmessage(...args))
        }
        onmessage() {}
        emit(data) {
          const event = new MessageEvent('message', { data: JSON.stringify(data) })
          return this.dispatchEvent(event)
        }
      }

      const stub = new EventSourceStub()

      const console = document.getElementById('console')
      console.src = stub

      let timer
      function start() {
        stop()
        timer = setInterval(() => stub.emit({ date: new Date() }), 500)
      }
      function stop() {
        clearInterval(timer)
      }
    </script>
  </body>
</html>
