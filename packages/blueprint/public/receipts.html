<!DOCTYPE html>
<html>
  <head>
    <title>Input Receipt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="upload-receipt-button.js"></script>
    <style>
      :root {
        background-color: #000;
        color: #eee;
      }
    </style>
  </head>
  <body>
    <div>
      <button onclick="load()">refresh</button>
      <dm-upload-receipt-button></dm-upload-receipt-button>
    </div>

    <table>
      <thead>
        <th>id</th>
        <td><button id="refresh">refresh</button><button onclick="addRow()">add</button></td>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <script type="module">
      import { API } from './API.js'
      const api = new API('/receipts')

      document.getElementById('refresh').onclick = async () => {
        api.events?.removeEventListener('message', onmessage)
        const data = await api.list()
        api.connect()
        api.events.addEventListener('message', onmessage)
        data.forEach((v) => addRow(v))
      }

      function onmessage(ev) {
        const data = JSON.parse(ev.data)
        console.log(data)
      }

      function addRow(v) {
        const tr = document.createElement('tr')
        tr.id = v.id
        const id = document.createElement('td')
        id.textContent = tr.id
        tr.append(id)
        document.getElementById('tbody').append(tr)
      }
    </script>

    <div id="thumbnails" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px"></div>

    <template id="tmpl">
      <style>
        :host {
          position: relative;
        }
        span {
          position: absolute;
          background-color: '#0005';
          color: '#fff';
          white-space: 'break-all';
          bottom: 0;
        }
        img {
          width: 100%;
        }
      </style>
    </template>

    <script>
      customElements.define(
        'dm-thumbnail',
        class extends HTMLElement {
          root
          text
          img
          constructor() {
            super()
            const root = this.attachShadow({ mode: 'open' })
            const text = document.createElement('span')
            const img = document.createElement('img')
            root.append(text)
            root.append(img)
            this.text = text
            this.img = img
            this.root = root
          }

          connectedCallback() {
            if (!this.isConnected) return
            this.img.src = this.getAttribute('src')
            this.text.textContent = this.getAttribute('data-text')
            this.root.append(tmpl.content.cloneNode(true))
          }
        }
      )

      async function load() {
        thumbnails.innerHTML = ''
        const res = await fetch('/receipts')
        const data = await res.json()
        for (const item of data) {
          const thumbnail = document.createElement('dm-thumbnail')
          thumbnail.setAttribute('src', `/receipts/${item.id}`)
          thumbnail.setAttribute('data-text', JSON.stringify(item))
          thumbnails.append(thumbnail)
        }
      }

      onload = () => load()
    </script>

    <dm-matrix-code
      src="/"
      style="position: fixed; top: 0; left: 0; bottom: 0; right: 0; z-index: -999"
    ></dm-matrix-code>
    <script src="matrix-code.js"></script>
  </body>
</html>
