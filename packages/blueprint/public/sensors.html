<!DOCTYPE html>
<html>
  <head>
    <title>Sensors</title>
    <script src="matrix-code.js"></script>
  </head>

  <body>
    <dm-matrix-code
      id="matrix"
      style="
        position: absolute;
        top: 0;
        left: 0;
        z-index: -999;
        opacity: 0.5;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      "
    ></dm-matrix-code>
    <script>
      const matrix = document.getElementById('matrix')

      const src = new EventSource('/')
      src.onmessage = (ev) => matrix.render(ev.data)

      // function genString() {
      //   return new Date()
      //     .toISOString()
      //     .repeat(6)
      //     .slice(Math.floor(Math.random() * 300))
      // }

      // setInterval(() => {
      //   matrix.render('XYZ'.repeat(100))
      //   matrix.render(genString())
      //   matrix.render(genString())
      //   matrix.render(genString())
      //   matrix.render(genString())
      // }, 100)
    </script>

    <div>
      <button onclick="load()">refresh</button>
    </div>
    <table>
      <thead>
        <th>id</th>
        <th>date</th>
        <th>temperature</th>
        <th>humidity</th>
        <th>magnet</th>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <hr />
    <pre id="dump"></pre>

    <template id="row">
      <tr>
        <td id="id"></td>
        <td id="date"></td>
        <td id="temperature"></td>
        <td id="humidity"></td>
        <td id="magnet"></td>
      </tr>
    </template>

    <script>
      const id = new URLSearchParams(location.search).get('id')
      async function load() {
        const res = await fetch(`/sensors`)
        const sensors = await res.json()
        document.getElementById('dump').textContent = JSON.stringify(sensors, null, 2)

        const template = document.querySelector('template#row')
        const tbody = document.getElementById('tbody')
        tbody.textContent = null
        console.log(sensors)
        sensors.forEach(({ date, temperature, humidity, magnet, id }) => {
          const templ = template.content.cloneNode(true)
          templ.getElementById('id').textContent = id
          templ.getElementById('date').textContent = date
          templ.getElementById('temperature').textContent = temperature
          templ.getElementById('humidity').textContent = humidity
          templ.getElementById('magnet').textContent = magnet
          tbody.append(templ)
        })
      }

      window.addEventListener('load', () => {
        load()
      })
    </script>
  </body>
</html>
