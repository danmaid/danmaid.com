<!DOCTYPE html>
<html lang="ja">

<head>
  <title>connections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <table>
    <thead>
      <th>id</th>
      <th>method</th>
      <th>url</th>
      <th>version</th>
      <th>connection</th>
      <th>status</th>
      <th>reason</th>
    </thead>
    <tbody id="tbody">
      <template id="row">
        <tr>
          <td id="_id"></td>
          <td id="method"></td>
          <td id="url"></td>
          <td id="version"></td>
          <td id="connection"></td>
          <td id="status"></td>
          <td id="reason"></td>
          <td>
            <button id="close">close</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
  <script type="module">
    const tbody = document.getElementById("tbody");
    const template = document.getElementById("row");

    function add(id) {
      const row = template.content.cloneNode(true);
      row.firstElementChild.id = id;
      row.querySelector("#_id").textContent = id;
      row.querySelector("#close").addEventListener("click", () => {
        fetch(id, { method: "DELETE" });
      });
      tbody.append(row);
      get(id);
    }

    async function get(id) {
      const res = await fetch(id);
      const item = await res.json();
      const row = document.getElementById(id);
      row.querySelector("#method").textContent = item.method;
      row.querySelector("#url").textContent = item.url;
      row.querySelector("#version").textContent = item.version;
      row.querySelector("#connection").textContent = item.connection;
      row.querySelector("#status").textContent = item.status;
      row.querySelector("#reason").textContent = item.reason;
    }

    const res = await fetch("index.json");
    const items = await res.json();
    for (const id of items) add(id);

    const es = new EventSource("");
    es.addEventListener("DELETE", (ev) =>
      document.getElementById(ev.data)?.remove()
    );
    es.addEventListener("POST", async (ev) => add(ev.data));
    es.addEventListener("PUT", async (ev) => get(ev.data));
  </script>
</body>

</html>