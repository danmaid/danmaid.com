<!DOCTYPE html>
<html lang="ja">

<head>
  <title>connections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <table>
    <thead>
      <th>id</th>
      <th>family</th>
      <th>address</th>
      <th>port</th>
    </thead>
    <tbody id="tbody">
      <template id="row">
        <tr>
          <td id="_id"></td>
          <td id="family"></td>
          <td id="address"></td>
          <td id="port"></td>
          <td>
            <button id="close">close</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
  <script type="module">
    const tbody = document.getElementById("tbody");
    const template = document.getElementById("row");

    function add(id) {
      const row = template.content.cloneNode(true);
      row.firstElementChild.id = id;
      row.querySelector("#_id").textContent = id;
      row.querySelector("#close").addEventListener("click", () => {
        fetch(id, { method: "DELETE" });
      });
      tbody.append(row);
      get(id);
    }

    async function get(id) {
      const res = await fetch(id);
      const item = await res.json();
      const row = document.getElementById(id);
      row.querySelector("#family").textContent = item.family;
      row.querySelector("#address").textContent = item.address;
      row.querySelector("#port").textContent = item.port;
    }

    const res = await fetch("index.json");
    const items = await res.json();
    for (const id of items) add(id);

    const es = new EventSource("");
    es.addEventListener("DELETE", (ev) =>
      document.getElementById(ev.data)?.remove()
    );
    es.addEventListener("POST", async (ev) => add(ev.data));
    es.addEventListener("PUT", async (ev) => get(ev.data));
  </script>
</body>

</html>