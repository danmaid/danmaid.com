<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>connections</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div>connections</div>
    <table>
      <tbody id="tbody">
        <template id="row">
          <tr>
            <td id="_id"></td>
            <td id="family"></td>
            <td id="address"></td>
            <td id="port"></td>
            <td><button>close</button></td>
          </tr>
        </template>
      </tbody>
    </table>
    <script type="module">
      const x = new EventSource("/");
    </script>
    <script type="module">
      const res = await fetch("?include_docs=true", {
        headers: { accept: "application/json" },
      });
      const items = await res.json();
      const tbody = document.getElementById("tbody");
      const template = document.getElementById("row");
      for (const { id, doc: item } of items) {
        const row = template.content.cloneNode(true);
        row.firstElementChild.id = id;
        row.querySelector("#_id").textContent = id;

        row.querySelector("#family").textContent = item.family;
        row.querySelector("#address").textContent = item.address;
        row.querySelector("#port").textContent = item.port;
        tbody.append(row);
      }

      const es = new EventSource("");
      es.addEventListener("deleted", (ev) => {
        const row = document.getElementById(ev.data);
        if (row) row.remove();
      });
      es.addEventListener("added", async (ev) => {
        const tbody = document.getElementById("tbody");
        const template = document.getElementById("row");
        const id = ev.data;
        const row = template.content.cloneNode(true);
        row.firstElementChild.id = id;
        row.querySelector("#_id").textContent = id;
        const res = await fetch(id, {
          headers: { Accept: "application/json" },
        });
        if (!res.ok) return;
        const item = await res.json();
        row.querySelector("#family").textContent = item.family;
        row.querySelector("#address").textContent = item.address;
        row.querySelector("#port").textContent = item.port;
        tbody.append(row);
      });
    </script>
  </body>
</html>
